!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Astrovis=t():e.Astrovis=t()}(this,(()=>(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);class t extends Error{constructor(e){super(e),this.name="InvalidURLError"}}class s extends Error{constructor(e){super(e),this.name="HDUNotTabularError"}}class i extends Error{constructor(e){super(e),this.name="EventNotFoundInRegistryError"}}class a{static events_subscribers={"fits-loaded":["settings-component","file-component"],configuration:["settings-component"],"file-loaded":["file-component"],"file-selected":["settings-component"],"file-registry-change":["settings-component","file-component"]};constructor(){}getSubscribersForEvent(e){if(a.events_subscribers.hasOwnProperty(e))return a.events_subscribers[e];throw new i("Event not found : "+e)}}class n{constructor(){}getEventSubscribersRegistry(){return new a}static getRegistryContainer(){return new n}}class r{static defaultOptions={bubbles:!0,composed:!1};static name="file-registry-change";static main_root_id="jsvis-main";static main_root_element=null;event=null;constructor(e={},t={}){this.detail={...e},this.options={...r.defaultOptions,...t},this.event=new CustomEvent(r.name,{detail:this.detail,...this.options})}dispatchToTarget(e){e.dispatchEvent(this.event)}dispatchToMainRoot(){null===r.main_root_element&&(r.main_root_element=document.getElementById(r.main_root_id)),document.dispatchEvent(this.event)}dispatchToSubscribers(){let e=n.getRegistryContainer().getEventSubscribersRegistry().getSubscribersForEvent(r.name),t=null;e.forEach((e=>{t=document.getElementById(e),t.dispatchEvent(this.event)}))}}class l{static cleanFileName(e){return e.startsWith(".")||e.startsWith("/")?(e=e.substring(1),l.cleanFileName(e)):e}}class o{static available_files=[];static current_files=[];static file_counter=0;constructor(){}static getAvailableFilesList(){return o.available_files=o.available_files.filter((e=>void 0!==e)),o.available_files}static getCurrentFilesList(){return o.current_files=o.current_files.filter((e=>void 0!==e)),o.current_files}static addToAvailableFiles(e){let t={...e,id:o.file_counter,file_name:l.cleanFileName(e.file_name)};o.available_files.push(t),o.file_counter++}static moveToAvailableFiles(e){o.available_files.push(e)}static removeFromAvailableFiles(e){o.available_files=o.available_files.filter((t=>t.id!==parseInt(e)))}static addToCurrentFiles(e){o.current_files.push(e),o.removeFromAvailableFiles(e.id)}static removeFromCurrentFiles(e){let t=o.current_files.find((t=>t.id===parseInt(e)));o.current_files=o.current_files.filter((t=>t.id!==parseInt(e))),o.moveToAvailableFiles(t)}static getFileById(e){return[...o.available_files,...o.current_files].find((t=>t.id===parseInt(e)))}static getFileByName(e){return[...o.available_files,...o.current_files].find((t=>t.file_name===e))}static isFileCurrent(e){let t=!1;return o.current_files.some((t=>t.id===parseInt(e)))&&(t=!0),t}static sendRegistryChangeEvent(){(new r).dispatchToSubscribers()}}class d{static defaultOptions={bubbles:!0,composed:!1};static name="file-loaded";static main_root_id="jsvis-main";static main_root_element=null;event=null;constructor(e={},t={}){this.detail={...e},this.options={...d.defaultOptions,...t},this.event=new CustomEvent(d.name,{detail:this.detail,...this.options})}dispatchToTarget(e){e.dispatchEvent(this.event)}dispatchToMainRoot(){null===d.main_root_element&&(d.main_root_element=document.getElementById(d.main_root_id)),document.dispatchEvent(this.event)}dispatchToSubscribers(){let e=n.getRegistryContainer().getEventSubscribersRegistry().getSubscribersForEvent(d.name),t=null;e.forEach((e=>{t=document.getElementById(e),t.dispatchEvent(this.event)}))}}class c{file_path=null;file=null;static BINTABLE="BINTABLE";static TABLE="TABLE";constructor(e=null){if(e){if(!c.is_path_valid(e))throw new t("Invalid file path : "+e);this.file_path=e,this._getFile()}}initializeFromPath(e){if(!c.is_path_valid(e))throw new t("Invalid file path : "+e);this.file_path=e,this._getFile()}initializeFromBuffer(e,t){this.file_path=t,this._readFile(e)}_getFile(){return fetch(this.file_path).then((e=>{if(!e.ok)throw new Error(`HTTP error, status = ${e.status}`);return e.arrayBuffer()})).then((e=>this._readFile(e)))}_readFile(e){try{this.file=window.FITSReader.parseFITS(e),this.sendFITSLoadedEvents()}catch(e){console.log("Error initializing interface")}}getFilePath(){return this.file_path}setFile(e){this.file=e}getHDU(e){return e>=0&&e<this.file.hdus.length?this.file.hdus[e]:null}getHDUs(){let e,t,s=[],i="";return this.file.hdus.forEach((function(a,n){!0===a.header.primary?t="PRIMARY":(t=a.header.get("XTENSION"),i=a.header.get("EXTNAME")),e={name:t,index:n,extname:i},s.push(e)})),s}getTabularHDUs(){let e=[];return this.file.hdus.forEach((function(t,s){!0!==t.header.primary&&("TABLE"!==t.header.get("XTENSION")&&"BINTABLE"!==t.header.get("XTENSION")||e.push(s))})),e}getNumberOfColumnFromHDU(e){let t=this.file.getHDU(e),i=t.header,a=t.data,n=i.get("XTENSION"),r=null;if(n!==c.BINTABLE&&n!==c.TABLE)throw new s("Selected HDU is not tabular");return r=a.cols,r}getColumnsNameFromHDU(e){let t,i=this.file.getHDU(e),a=(i.header,i.data),n=i.header.get("XTENSION"),r=[];if(n!==c.BINTABLE&&n!==c.TABLE)throw new s("Selected HDU is not tabular");return a.columns.forEach((function(e){t=e,r.push(t)})),r}getColumnsJSONDataFromHDU(e){let t,i=this.file.getHDU(e),a=(i.header,i.data),n=i.header.get("XTENSION"),r=[],l=[];if(n!==c.BINTABLE&&n!==c.TABLE)throw new s("Selected HDU is not tabular");{a.columns.forEach((function(e){try{a.getColumn(e,(function(e){t=e}))}catch(e){}l[e]=t}));let e=Object.keys(l);for(let t=0;t<l[e[0]].length;t++){let s={};e.forEach((e=>{s[e]=l[e][t]})),r.push(s)}}return r}getColumnDataFromHDU(e,t){let i=this.file.getHDU(e),a=(i.header,i.data),n=i.header.get("XTENSION"),r=[];if(n!==c.BINTABLE&&n!==c.TABLE)throw new s("Selected HDU is not tabular");return a.getColumn(t,(function(e){if(void 0===e[0]){let s=i.header.get(t);e=e.map((()=>s))}r=e})),r}getHeaderFromHDU(e){return this.file.getHDU(e).header}getDataFromHDU(e){return this.file.getHDU(e).data}getHeaderCardValueByNameFromHDU(e,t){let s=this.file.getHDU(e).header.get(t);return void 0===s&&(s=""),s}getHeaderCardsValueFromHDU(e){let t=this.file.getHDU(e);const s=[];return Object.entries(t.header.cards).forEach((function(e){let t=e[1];"object"!=typeof t||Array.isArray(t)||(t.card_name=e[0],s.push(t))})),s.sort(((e,t)=>e.index-t.index))}isHDUTabular(e){let t=this.file.getHDU(e).header.get("XTENSION"),s=!1;return t!==c.BINTABLE&&t!==c.TABLE||(s=!0),s}_isHDUTabular(e){let t=e.header.get("XTENSION");return t===c.BINTABLE||t===c.TABLE}getAllColumns(){let e=[];return this.file.hdus.forEach(((t,s)=>{if(this._isHDUTabular(t)){if(this.getColumnsNameFromHDU(s).forEach((t=>{let i={name:t,hdu_index:s,is_from_header:!1};e.push(i)})),null!==t.header.get("TIMEDEL")){let t={name:"TIMEDEL",hdu_index:s,is_from_header:!0};e.push(t)}if(null!==t.header.get("ANCRFILE")){let e=o.getFileByName(l.cleanFileName(t.header.get("ANCRFILE")));void 0!==e&&(new c).setFile(e.file)}if(null!==t.header.get("RESPFILE")){let s=o.getFileByName(l.cleanFileName(t.header.get("RESPFILE")));if(void 0!==s){let t=new c;t.setFile(s.file);let i=t.getTabularHDUs(),a=!1;i.forEach((i=>{let n=t.getColumnsNameFromHDU(i);if(n.includes("E_MIN")&&n.includes("E_MAX")){a=!0;let t={name:"E_HALF_WIDTH",hdu_index:i,is_from_header:!1,is_processed:!0,from_file:s.id};e.push(t),t={name:"E_MID",hdu_index:i,is_from_header:!1,is_processed:!0,from_file:s.id},e.push(t),t={name:"E_MID_LOG",hdu_index:i,is_from_header:!1,is_processed:!0,from_file:s.id},e.push(t)}}))}}}})),e}sendFITSLoadedEvents(){new d({file_name:this.file_path,type:"fits",file:this.file}).dispatchToSubscribers()}static is_path_valid(e){let t=!1;return(c._isPathValid(e)||c._isURLValid(e))&&(t=!0),t}static _isURLValid(e){return/^(ftp|http|https):\/\/[^ "]+$/.test(e)}static _isPathValid(e){return/^(\/[a-zA-Z0-9._-]+)+\/?$/.test(e)}}class h{static defaultOptions={bubbles:!0,composed:!1,cancelable:!0};static name="configuration";event=null;constructor(e,t={},s={}){this.detail={...t,configuration_object:e},this.options={...h.defaultOptions,...s},this.event=new CustomEvent(h.name,{detail:this.detail,...this.options})}dispatchToSubscribers(){let e=n.getRegistryContainer().getEventSubscribersRegistry().getSubscribersForEvent(h.name),t=null;e.forEach((e=>{t=document.getElementById(e),t.dispatchEvent(this.event)}))}}class u{container_id=null;container=null;static plt=Bokeh.Plotting;static scale_functions={linear:Bokeh.LinearScale,log:Bokeh.LogScale};source=null;y_error_bar;x_error_bar;columns;data_table;static supported_tool_array=["pan","box_zoom","wheel_zoom","hover","crosshair","reset","save","lasso_select","poly_select","tap","examine,","undo","redo"];static default_tool_array=["pan","box_zoom","wheel_zoom","hover","crosshair","reset","save"];static default_tool_string="pan,box_zoom,wheel_zoom,hover,crosshair,reset,save";tool_array=[];tool_string="";has_data_table=!1;constructor(e="#visualization-container"){this.container_id=e,this._setContainer()}_setContainer(){this.container=document.getElementById(this.container_id)}initializeSettings(e,t,s,i,a=null,n=null){if(this.setupSource(e),a)this.setupPlot(i,e.y_low,e.y_up);else if(n){let t=[],s=[],a=[],r=[];null!==n.x?(null!==n.x.lower_bound?t.push(n.x.lower_bound):t=e.x,null!==n.x.upper_bound?s.push(n.x.upper_bound):s=e.x):(t=e.x,s=e.x),null!==n.y?(null!==n.y.lower_bound?a.push(n.y.lower_bound):a=e.y,null!==n.y.upper_bound?r.push(n.y.upper_bound):r=e.y):(a=e.y,r=e.y),this.setupPlot(i,a,r,t,s)}else this.setupPlot(i,e.y,e.y);this.setupData(),this.setupScales(s),this.setupLabels(t),a&&this.setupErrorBars()}initializeGraph(){this.has_data_table?u.plt.show(new Bokeh.Column({children:[p,data_table]}),"#graph-container"):u.plt.show(this.plot,this.container_id)}setupPlot(e,t,s,i=null,a=null){this.plot=u.plt.figure({title:e,tools:u.default_tool_string,width:800,height:600})}setupSource(e){this.source=new Bokeh.ColumnDataSource({data:e})}setupData(){this.plot.circle({field:"x"},{field:"y"},{source:this.source,size:4,fill_color:"navy",line_color:null})}setupErrorBars(){this.y_error_bar=new Bokeh.Whisker({dimension:"height",source:this.source,base:{field:"x"},lower:{field:"y_low"},upper:{field:"y_up"},line_color:"navy",lower_head:null,upper_head:null}),this.x_error_bar=new Bokeh.Whisker({dimension:"width",source:this.source,base:{field:"y"},lower:{field:"x_low"},upper:{field:"x_up"},line_color:"navy",lower_head:null,upper_head:null}),this.plot.add_layout(this.y_error_bar),this.plot.add_layout(this.x_error_bar)}setupScales(e){e&&(this.plot.x_scale=new u.scale_functions[e.x],this.plot.y_scale=new u.scale_functions[e.y])}setupLabels(e){this.plot.xaxis.axis_label=e.x,this.plot.yaxis.axis_label=e.y}setupColumns(e,t){this.columns=[new Bokeh.Tables.TableColumn({field:"x",title:e.x}),new Bokeh.Tables.TableColumn({field:"y",title:e.y})]}setupDataTable(){this.data_table=new Bokeh.Tables.DataTable({source:this.source,columns:this.columns,width:800})}createToolArray(e){this.tool_array=e}addToolToToolArray(e){!this.tool_array.includes(e)&&u.supported_tool_array.includes(e)&&this.tool_array.push(e)}removeToolFromToolArray(e){this.tool_array=this.tool_array.filter((t=>t!==e))}setToolStringFromToolArray(){this.tool_string=this.tool_array.join(",")}}class _{x_scale;x_scale_type;y_scale;y_scale_type;x_axis;x_axis_data_col;y_axis;y_axis_data_col;dataset;svg;plot;clip;zoom_rect;zoom;line_container;path;container;container_id;margin={top:10,right:30,bottom:30,left:60};width=800-this.margin.left-this.margin.right;height=400-this.margin.top-this.margin.bottom;has_error_bars=!1;x_axis_data_col_error_bar;y_axis_data_col_error_bar;has_line=!1;has_multiple_plots=!1;additional_plots=[];initialized;static scale_functions={linear:d3.scaleLinear,log:d3.scaleLog};static default_scales={x:"linear",y:"linear"};static default_axis_tick_format=".2f";constructor(e="visualization-container",t=null){this.container_id=e,this.dataset=t,this._setContainer(),this._updateChart=this._updateChart.bind(this),this.initialized=!1}_setContainer(){this.container=document.getElementById(this.container_id)}initializeSettings(e,t,s=_.default_scales,i=null,a=!1,n=null){let r=!1;try{if(this.dataset=e,this.x_axis_data_col=t.x,this.y_axis_data_col=t.y,this.x_scale_type=s.x,this.y_scale_type=s.y,i?(this.has_error_bars=!0,this.error_bars=i,this.x_axis_data_col_error_bar=t.x.value,this.y_axis_data_col_error_bar=t.y.value):this.has_error_bars=!1,n){this.has_multiple_plots=!0,this.additional_plots=[];let e=[];n.forEach((function(t){e.push(t)})),this.additional_plots=e}this.has_line=a,r=!0}catch(e){console.log("Error during graph settings process")}return r}initializeGraph(){try{this._setSVGContainer(),this._setXScale(),this._setYScale(),this._setXAxis(),this._setXAxisLabel(),this._setYAxis(),this._setYAxisLabel(),this._setDataPlot(),this._setZoomBehavior(),this.has_error_bars&&this._setErrorBars(this.error_bars),this.has_line&&this._setAxisLine(),this.has_multiple_plots&&this._setAdditionalPlots(),this.initialized=!0}catch(e){console.log("Error during graph initialization"),this.initialized=!1}return this.initialized}_setSVGContainer(){let e=this._getFullWidth(),t=this._getFullHeight();this.svg=d3.select(this.container).append("svg").attr("width",e).attr("height",t).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")}_setXScale(){this.x_scale=_.scale_functions[this.x_scale_type]().domain(d3.extent(this.dataset,(e=>e[this.x_axis_data_col]))).range([0,this.width])}_setYScale(){this.y_scale=_.scale_functions[this.y_scale_type]().domain(d3.extent(this.dataset,(e=>e[this.y_axis_data_col]))).range([this.height,0])}_setXAxis(e=_.default_axis_tick_format){this.x_axis=this.svg.append("g").attr("id","x").attr("transform","translate(0,"+this.height+")").call(d3.axisBottom(this.x_scale).tickFormat(d3.format(e))).call((e=>e.selectAll(".tick line").clone().attr("class","tick-line").attr("y2",-this.height).attr("stroke-opacity",.2)))}_setYAxis(e=_.default_axis_tick_format){this.y_axis=this.svg.append("g").attr("id","y").call(d3.axisLeft(this.y_scale).tickFormat(d3.format(e))).call((e=>e.selectAll(".tick line").clone().attr("x2",this.width).attr("stroke-opacity",.2)))}_setXAxisLabel(){this.x_axis.select(".tick:last-of-type text").clone().attr("id","x-label").attr("y",-11).attr("x",2).attr("text-anchor","start").attr("font-weight","bold").text(this.x_axis_data_col)}_setYAxisLabel(){this.y_axis.select(".tick:last-of-type text").clone().attr("id","y-label").attr("x",3).attr("y",-5).attr("text-anchor","start").attr("font-weight","bold").text(this.y_axis_data_col)}_setDataPlot(){let e=this.x_scale,t=this.y_scale,s=this.x_axis_data_col,i=this.y_axis_data_col;this.clip=this.svg.append("defs").append("SVG:clipPath").attr("id","clip").append("SVG:rect").attr("width",this.width).attr("height",this.height).attr("x",0).attr("y",0),this.plot=this.svg.append("g").attr("clip-path","url(#clip)").attr("id","data-plot"),this.plot.selectAll("circle").data(this.dataset).enter().append("circle").attr("cx",(function(t){return e(t[s])})).attr("cy",(function(e){return t(e[i])})).attr("r",4).style("fill","transparent").style("stroke","black").style("opacity",1)}_setAdditionalPlots(){let e;for(let t=0;this.additional_plots.length,t++;)e=this.additional_plots[t]}_setErrorBars(e){this.error_bars=e,e.x;let t=d3.line().x((e=>this.x_scale(e[this.x_axis_data_col]))).y((e=>this.y_scale(e.bound)));e.x.forEach((e=>{d3.select("#data-plot").append("path").attr("class","error-bar-x").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.5).attr("d",t(e))}));let s=d3.line().x((e=>this.x_scale(e.bound))).y((e=>this.y_scale(e[this.y_axis_data_col])));e.y.forEach((e=>{d3.select("#data-plot").append("path").attr("class","error-bar-x").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.5).attr("d",s(e))}))}_setAxisLine(){let e=d3.line().curve(d3.curveCatmullRom).x((e=>this.x_axis(e[this.x_axis_data_col]))).y((e=>this.y_axis(e[this.y_axis_data_col])));this.line_container=this.svg.append("g").attr("id","path-container").attr("clip-path","url(#clip)"),this.path=this.line_container.append("path").attr("id","path").attr("fill","none").attr("stroke","steelblue").attr("d",e(data))}_setZoomBehavior(){this.zoom=d3.zoom().scaleExtent([.5,20]).extent([[0,0],[this.width,this.height]]).on("zoom",this._updateChart),this.zoom_rect=this.svg.append("rect").attr("width",this.width).attr("height",this.height).style("fill","none").style("pointer-events","all").attr("transform","translate("+this.margin.left+","+this.margin.top+")").call(this.zoom)}_updateChart(e){let t=e.transform.rescaleX(this.x_scale),s=e.transform.rescaleY(this.y_scale);this.x_axis.call(d3.axisBottom(t).tickFormat(d3.format(_.default_axis_tick_format))),this.y_axis.call(d3.axisLeft(s).tickFormat(d3.format(_.default_axis_tick_format))),this.svg.selectAll(".tick-line").remove(),this.svg.selectAll("#y-label").remove(),this.svg.selectAll("#x-label").remove(),this.svg.selectAll(".error-bar-x").remove(),this.x_axis.selectAll(".tick line").clone().attr("class","tick-line").attr("y2",-this.height).attr("stroke-opacity",.2),this.y_axis.selectAll(".tick line").clone().attr("class","tick-line").attr("x2",this.width).attr("stroke-opacity",.2),this._setXAxisLabel(),this._setYAxisLabel();let i=this.x_axis_data_col,a=this.y_axis_data_col;if(this.svg.selectAll("circle").data(this.dataset).transition().duration(150).attr("cx",(function(e){return t(e[i])})).attr("cy",(function(e){return s(e[a])})),this.has_line&&(this.svg.selectAll("path").remove(),this._setAxisLine()),this.has_error_bars){let e=d3.line().x((e=>t(e[this.x_axis_data_col]))).y((e=>s(e.bound)));this.error_bars.x.forEach((t=>{d3.select("#data-plot").append("path").attr("class","error-bar-x").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.5).attr("d",e(t))}));let i=d3.line().x((e=>t(e.bound))).y((e=>s(e[this.y_axis_data_col])));this.error_bars.y.forEach((e=>{d3.select("#data-plot").append("path").attr("class","error-bar-x").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.5).attr("d",i(e))}))}}_getFullWidth(){return this.width+this.margin.left+this.margin.right}_getFullHeight(){return this.height+this.margin.top+this.margin.bottom}}class g{static bokeh_graph=null;static d3_graph=null;static visualization_container="#visualization-container";constructor(){}static setBokehVisualization(e){g.bokeh_visualization=e}static setD3Visualization(e){g.d3_visualization=e}static getBokehVisualization(){return null!==g.bokeh_visualization?g.bokeh_visualization:new u(g.visualization_container)}static getD3Visualization(){return null!==g.d3_visualization?g.d3_visualization:new _(g.visualization_container)}}class m{static deep_merge(e,t){let s={};for(let t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);for(let e in t)t.hasOwnProperty(e)&&(Array.isArray(t[e])||(s.hasOwnProperty(e)&&"object"==typeof t[e]?s[e]=m.deep_merge(s[e],t[e]):s[e]=t[e]));return s}}class b{static default_configuration={"library-settings":{display:!0,selected:"none"},"bokeh-settings":{display:!1,"bokeh-options":{tools:{display:!1}}},"d3-settings":{display:!1,"d3-options":{}},"data-type-settings":{display:!0,selected:"generic"},"light-curve-settings":{display:!1,"light-curve-options":{}},"spectrum-settings":{display:!1,"spectrum-options":{}},"hdus-settings":{display:!1},"axis-settings":{display:!0},"error-bars-settings":{display:!0},"binning-settings":{display:!0},"additional-dataset-settings":{display:!0}};configuration=null;constructor(e=null){this.configuration=e?JSON.parse(JSON.stringify(b.default_configuration)):JSON.parse(JSON.stringify(e))}getConfigurationObject(e){let t=null;return t=m.deep_merge(b.default_configuration,e),t}static getConfigurationObject(e){let t=null;return t=m.deep_merge(b.default_configuration,e),t}}class f{static library="d3";static container_id="visualization-container";static specific_settings={"d3-settings":{display:!0,"d3-options":{has_line:!0,display:!1}}};container;container_id;settings_object;configuration_object=null;constructor(e=f.container_id){this._setupListeners(),this.container_id=e,this._setContainer()}_setupListeners(){document.addEventListener("settings-changed",this.handleSettingsChangedEvent.bind(this)),document.addEventListener("visualization-generation",this.handleVisualizationGenerationEvent.bind(this))}handleSettingsChangedEvent(e){e.detail.settings_object.getLibrarySettings().library===f.library&&(this.createConfigurationObject(),null!==this.configuration_object)&&new h(this.configuration_object).dispatchToSubscribers()}handleVisualizationGenerationEvent(e){if(this.settings_object=e.detail.settings_object,this.settings_object.getLibrarySettings().library===f.library){this.resetContainer();let e={},t=this.settings_object.getDataTypeSettings(),s=this.settings_object.getAxisSettings(),i=this.settings_object.getScalesSettings(),a=this.settings_object.getErrorBarsSettings(),n=this.settings_object.getRangesSettings(),r=!1;e.data_type=t;let l=[];for(let e in s){let t=this._getColumnSettings(s[e]);t={...t,axis:e},l.push(t)}if(e.axis=l,null!==a){r=!0;let t=[];for(let e in a){let s=this._getColumnSettings(a[e]);s={...s,axis:e},t.push(s)}e.error_bars=t}let o=S.getDataProcessorContainer().getDataPreProcessor(),d=o.getProcessedDataset(e),c=o.datasetToJSONData(d);if(s={x:d.axis[0].column_name,y:d.axis[1].column_name},r&&(a={x:d.error_bars[0].column_name,y:d.error_bars[1].column_name},a=o.processErrorBarDataJSON(c,s,a)),null!=n){let e=null;r?(e=o.processDataForRange(n,c,a),c=e.data,a=e.error_bars):(e=o.processDataForRange(n,c),c=e.data)}let h=g.getD3Visualization();h.initializeSettings(c,s,i,a,!1,null),h.initializeGraph()}}_setContainer(){this.container=document.getElementById(this.container_id)}resetContainer(){this.container.innerHTML=""}createConfigurationObject(){this.configuration_object=b.getConfigurationObject(f.specific_settings)}_getColumnSettings(e){let t=e.split("$"),s=t[0].split("."),i=t[1]||"";return{file_id:s[0],hdu_index:s.length>1?s[1]:"",column_name:i}}}class y{static fits_reader_wrapper=null;static bokeh_wrapper=null;static d3_wrapper=null;static visualization_container="visualization-container";constructor(){}static setFITSReaderWrapper(e){y.fits_reader_wrapper=e}static setBokehWrapper(e){y.bokeh_wrapper=e}static setD3Wrapper(e){y.d3_wrapper=e}static getFITSReaderWrapper(){return null!==y.fits_reader_wrapper?y.fits_reader_wrapper:new c("")}static getBokehWrapper(){return null!==y.bokeh_wrapper?y.bokeh_wrapper:new F(y.visualization_container)}static getD3Wrapper(){return null!==y.d3_wrapper?y.d3_wrapper:new f(y.visualization_container)}}class v{static processed_columns_name=["E_HALF_WIDTH","E_MID","E_MID_LOG"];static spectrum_col_functions={E_HALF_WIDTH:v.getEnergyHalfWidth,E_MID:v.getEnergyMidPoint,E_MID_LOG:v.getEnergyMidPointLog};constructor(){}static getEnergyHalfWidth(e,t){return(t-e)/2}static getEnergyMidPoint(e,t){return(t+e)/2}static getEnergyMidPointLog(e,t){return Math.sqrt(t*e)}static getEneryErrorBar(e,t,s){}}class E{constructor(){}getProcessedDataset(e){let t={};return e.axis.forEach((t=>{let s,i=o.getFileById(t.file_id),a=y.getFITSReaderWrapper();a.setFile(i.file),s="spectrum"===e.data_type.type&&v.processed_columns_name.includes(t.column_name)?this.getSpectrumProcessedColumn(t.hdu_index,t.column_name,a):a.getColumnDataFromHDU(t.hdu_index,t.column_name),t.data=s})),e.hasOwnProperty("error_bars")&&e.error_bars.forEach((t=>{let s,i=o.getFileById(t.file_id),a=y.getFITSReaderWrapper();a.setFile(i.file),s="spectrum"===e.data_type.type&&v.processed_columns_name.includes(t.column_name)?this.getSpectrumProcessedColumn(t.hdu_index,t.column_name,a):a.getColumnDataFromHDU(t.hdu_index,t.column_name),t.data=s})),t=e,t}datasetToJSONData(e){let t=[];return e.axis.forEach((e=>{e.data.forEach(((s,i)=>{t[i]||(t[i]={}),t[i][e.column_name]=s}))})),e.hasOwnProperty("error_bars")&&e.error_bars.forEach((e=>{e.data.forEach(((s,i)=>{t[i]||(t[i]={}),t[i][e.column_name]=s}))})),t}processErrorBarDataJSON(e,t,s){let i=[],a=[],n=t.x,r=t.y,l=s.x,o=s.y;return e.forEach((function(e){let t=[{bound:parseFloat(e[r])-parseFloat(e[o]),[n]:parseFloat(e[n])},{bound:parseFloat(e[r])+parseFloat(e[o]),[n]:parseFloat(e[n])}],s=[{bound:parseFloat(e[n])-parseFloat(e[l]),[r]:parseFloat(e[r])},{bound:parseFloat(e[n])+parseFloat(e[l]),[r]:parseFloat(e[r])}];i.push(t),a.push(s)})),{x:i,y:a}}getSpectrumProcessedColumn(e,t,s){let i=[],a=(S.getDataProcessorContainer().getSpectrumProcessor(),s.getColumnDataFromHDU(e,"E_MIN")),n=s.getColumnDataFromHDU(e,"E_MAX");return a.forEach(((e,s)=>{i.push(v.spectrum_col_functions[t](e,n[s]))})),i}processDataForRange(e,t,s=null){let i=[],a={},n=[],r=[],l=[];return t.forEach(((t,a)=>{let l=Object.keys(t),o=l[0],d=l[1];null===e.x||t[o]>=e.x.lower_bound&&t[o]<=e.x.upper_bound?t.match_range_x=!0:t.match_range_x=!1,null===e.y||t[d]>=e.y.lower_bound&&t[d]<=e.y.upper_bound?t.match_range_y=!0:t.match_range_y=!1,t.match_range_x+t.match_range_y==2&&(i.push(t),null!=s&&(n.push(s.x[a]),r.push(s.y[a])))})),null!=s&&(a.x=n,a.y=r,l.error_bars=a),l.data=i,l}processDataForRangeBokeh(e,t,s=!1){let i={x:[],y:[]};s&&(i.x_low=[],i.x_up=[],i.y_low=[],i.y_up=[]);let a=[],n=[];return t.x.forEach((t=>{let s={};s.value=t,null===e.x||t>=e.x.lower_bound&&t<=e.x.upper_bound?s.match_range_x=!0:s.match_range_x=!1,a.push(s)})),t.y.forEach((t=>{let s={};s.value=t,null===e.y||t>=e.y.lower_bound&&t<=e.y.upper_bound?s.match_range_y=!0:s.match_range_y=!1,n.push(s)})),a.forEach(((e,a)=>{let r=n[a];e.match_range_x+r.match_range_y==2&&(i.x.push(e.value),i.y.push(r.value),s&&(i.y_low.push(t.y_low[a]),i.y_up.push(t.y_up[a]),i.x_low.push(t.x_low[a]),i.x_up.push(t.x_up[a])))})),i}}class x{static header_cards=["TIMEREF","TIMEDEL","MJDREF","TSTART","TSTOP","TELAPSE","E_MIN","E_MAX","E_UNIT"];static columns_names={time:"TIME",timedel:"TIMEDEL",rate:"RATE",error:"ERROR",fracexp:"FRACEXP"};static binning_types={TIME_BASED:"time_based",EQUAL_COUNT:"equal_count"};static bin_value_methods=["mean","weightedmean","median","wmedian","stddev","meddev","kurtosis","skewness","max","min","sum"];static min_columns_number=2;static mandatory_columns=["RATE"];static replacement_columns=["TIMEDEL"];hdu;hdu_index=null;binning_type;method;fits_reader_wrapper;header_values={};constructor(e,t){this.fits_reader_wrapper=e,this.hdu_index=t,this._setHDU()}_setHDU(){this.hdu=this.fits_reader_wrapper.getHDU(this.hdu_index)}setHDU(e,t){this.hdu=e,this.hdu_index=t}processDataRawJSON(e,t=null){let s,i,a=this.fits_reader_wrapper.getDataFromHDU(this.hdu_index),n={},r=e.x,l=e.y;if(a.getColumn(r,(function(e){s=e})),a.getColumn(l,(function(e){i=e})),n.x=s,n.y=i,t){let e,s=t.x,i=t.y;a.getColumn(i,(function(t){e=t})),n.dy=e,a.getColumn(s,(function(e){n.timedel=e}))}return n}processDataJSON(e,t=null){this.hdu.data;let s={};if(!this._checkColumns())throw new Error("");return s.main=this.fits_reader_wrapper.getColumnsJSONDataFromHDU(this.hdu_index),t&&(s.error_bars=this._processErrorBarsDataJSON(t,e,s.main)),s}_processErrorBarsDataJSON(e,t,s){let i=[],a=[],n=t.x,r=t.y,l=e.x,o=e.y;return s.forEach((function(e){let t=[{bound:parseFloat(e[r])-parseFloat(e[o]),[n]:parseFloat(e[n])},{bound:parseFloat(e[r])+parseFloat(e[o]),[n]:parseFloat(e[n])}],s=[{bound:parseFloat(e[n])-parseFloat(e[l]),[r]:parseFloat(e[r])},{bound:parseFloat(e[n])+parseFloat(e[l]),[r]:parseFloat(e[r])}];i.push(t),a.push(s)})),{x:i,y:a}}_checkColumns(e){let t=!0,s=this.fits_reader_wrapper.getNumberOfColumnFromHDU(this.hdu_index),i=this.fits_reader_wrapper.getColumnsNameFromHDU(this.hdu_index);return(s<e||!i.includes(x.columns_names.rate))&&(t=!1),t}getTimedel(e=null){let t;if(this.fits_reader_wrapper.getColumnsNameFromHDU(this.hdu_index).includes("TIMEDEL"))data.getColumn(e,(function(e){t=e}));else{let e=this.fits_reader_wrapper.getHeaderFromHDU(this.hdu_index);t=e.get("TIMEDEL")}return t}_getValueFromHDUHeader(){let e;x.header_cards.forEach((t=>{e=null,e=this.fits_reader_wrapper.getHeaderCardValueByNameFromHDU(this.hdu_index,t),this.header_values[t]=e}))}setBinningType(e){this.binning_type=e}setBinValueMethod(e){this.method=e}getBinsForMethod(e,t,s,i){return s.forEach((e=>{let t=[],s=[],i=[];e.forEach((({time:e,rate:a,fracexp:n})=>{t.push(e),s.push(a),i.push(n)})),Math.max(...s),Math.min(...s),s.reduce(((e,t)=>e+t),0),s.length,s.reduce(((e,t)=>e+t),0)})),[]}getRateFracexpWeightedMeanBinnedData(e,t,s){let i=e.length,a=Math.ceil(i/s),n=[];for(let i=0;i<a;i++){let a=i*s,r=Math.min(a+s,e.length),l=0,o=0;for(let s=a;s<r;s++)l+=e[s]*t[s],o++;let d=l/o;n.push(d)}return n}getMedianDate(e){let t=e.sort(((e,t)=>e-t)),s=Math.floor(t.length/2);if(t.length%2!=0)return t[s]}getDurationInSeconds(e){let t=Math.min(...e);return 86400*(Math.max(...e)-t)}}class S{constructor(){}getDataPreProcessor(){return new E}getLightCurveProcessor(e,t){return new x(e,t)}getSpectrumProcessor(){return new v}static getDataProcessorContainer(){return new S}}class F{static container_id="visualization-container";static library="bokeh";static title={"light-curve":"Light curve",spectrum:"spectrum"};static specific_settings={"bokeh-settings":{display:!0,"bokeh-options":{tools:{display:!1}}}};container=null;configuration_object=null;constructor(){this._setContainer(),this._setupListeners()}_setContainer(){this.container=document.getElementById(F.container_id)}_resetContainer(){this.container.innerHTML=""}_setupListeners(){document.addEventListener("settings-changed",this.handleSettingsChangedEvent.bind(this)),document.addEventListener("visualization-generation",this.handleVisualizationGenerationEvent.bind(this))}handleSettingsChangedEvent(e){e.detail.settings_object.getLibrarySettings().library===F.library&&(this.createConfigurationObject(),null!==this.configuration_object)&&new h(this.configuration_object).dispatchToSubscribers()}handleVisualizationGenerationEvent(e){if(this.settings_object=e.detail.settings_object,this.settings_object.getLibrarySettings().library===F.library){this._resetContainer();let e={},t=this.settings_object.getAxisSettings(),s=[];for(let e in t){let i=this._getColumnSettings(t[e]);i={...i,axis:e},s.push(i)}e.axis=s,e.data_type=this.settings_object.getDataTypeSettings();let i=this.settings_object.getErrorBarsSettings(),a=!1;if(null!==i){let t=[];for(let e in i){let s=this._getColumnSettings(i[e]);s={...s,axis:e},t.push(s)}e.error_bars=t}let n=S.getDataProcessorContainer().getDataPreProcessor(),r=n.getProcessedDataset(e),l=(n.datasetToJSONData(r),this.settings_object.getDataTypeSettings(),this.settings_object.getHDUsSettings(),this.settings_object.getScalesSettings());t={x:r.axis[0].column_name,y:r.axis[1].column_name};let o=t;r.axis[0].data=r.axis[0].data.map((e=>isNaN(e)?0:e)),r.axis[1].data=r.axis[1].data.map((e=>isNaN(e)?0:e));let d={x:r.axis[0].data,y:r.axis[1].data};i&&(i={x:r.error_bars[0].column_name,y:r.error_bars[1].column_name},r.error_bars[0].data=r.error_bars[0].data.map((e=>isFinite(e)?e:0)),r.error_bars[1].data=r.error_bars[1].data.map((e=>isFinite(e)?e:0)),d.dx=r.error_bars[0].data.map((e=>isNaN(e)?0:e)),d.dy=r.error_bars[1].data.map((e=>isNaN(e)?0:e)),d=this._processErrorBarData(d),a=!0);let c=this.settings_object.getRangesSettings(),h=null;null!=c&&(h=a?n.processDataForRangeBokeh(c,d,!0):n.processDataForRangeBokeh(c,d),d=h);let u=g.getBokehVisualization();u.initializeSettings(d,o,l,F.title.data_type,i,c),u.initializeGraph()}}getProcessedData(e,t,s,i){let a,n=null,r=S.getDataProcessorContainer(),l=y.getFITSReaderWrapper();return"light-curve"===e?a=r.getLightCurveProcessor(l,t):"spectrum"===e&&(a=r.getSpectrumProcessor(l,t)),n=a.processDataRawJSON(s,i),i&&(n=this._processErrorBarData(n)),n}_getColumnSettings(e){let t=e.split("$"),s=t[0].split("."),i=t[1]||"";return{file_id:s[0],hdu_index:s.length>1?s[1]:"",column_name:i}}_processErrorBarData(e){let t=[],s=[],i=[],a=[];for(let n in e.dy)t[n]=e.y[n]-e.dy[n],s[n]=e.y[n]+e.dy[n],i[n]=e.x[n]-e.dx[n]/2,a[n]=e.x[n]+e.dx[n]/2;return e.y_low=t,e.y_up=s,e.x_low=i,e.x_up=a,delete e.dy,delete e.dx,e}createConfigurationObject(){this.configuration_object=b.getConfigurationObject(F.specific_settings)}}class L extends HTMLElement{container_id="fits-settings-container";select_hdu_id="select-hdu-file";table_header_id="table-header-data";table_data_id="table-data";file=null;is_current=!1;add_to_plot_btn_id="add-to-plot";remove_from_plot_btn_id="remove-from-plot";container='<div id="fits-settings-container" class="full-width-column" style="grid-column: 1 / span 2;"><div class="card"><div class="card-body"></div></div></div>';select_hdu_file='<select id="select-hdu-file" class="form-select"></select>';inner_container='<div class="inner-row"></div>';header_column='<div class="left-column"><div class="card-header">Header</div><div class="card-body"><div id="header-hdu-file"></div></div>';table_header='<table id="table-header-data" class="table table-striped">    <thead>    <tr>        <th scope="col">#</th>        <th scope="col">Name</th>        <th scope="col">Value</th>        <th scope="col">Comment</th>    </tr>    </thead>    <tbody class="table-group-divider">    </tbody></table>';data_column='<div class="right-column"><div class="card-header">Data</div><div class="card-body">   <div id="data-hdu-file">   </div></div>';table_data='<table id="table-data" class="table table-striped">    <thead>       <tr>       </tr>    </thead>    <tbody class="table-group-divider">    </tbody></table>';btn_save_settings='<button class="btn btn-success" id="save-file-settings">Save changes</button>';btn_add_to_plot='<button class="btn btn-primary" id="add-to-plot">Add to plot</button>;';btn_remove_from_plot='<button class="btn btn-danger" id="remove-from-plot">Remove from plot</button>';constructor(e,t){super(),this.file=e,this.is_current=t,this.innerHTML='<div class="full-width-column" style="grid-column: 1 / span 2;">\n                            <div class="card">\n                                <div class="card-header">File settings</div>\n                                <div class="card-body">\n                                    <select id="select-hdu-file" class="form-select">\n\n                                    </select>\n\n                                    <div class="inner-row">\n                                        <div class="left-column">\n                                            <div class="card">\n                                                <div class="card-header">Header</div>\n                                                <div class="card-body">\n                                                    <div id="header-hdu-file" class="file-data-container">\n                                                        <table id="table-header-data" class="table table-striped">\n                                                            <thead>\n                                                            <tr>\n                                                                <th scope="col">#</th>\n                                                                <th scope="col">Name</th>\n                                                                <th scope="col">Value</th>\n                                                                <th scope="col">Comment</th>\n                                                            </tr>\n                                                            </thead>\n                                                            <tbody class="table-group-divider">\n\n                                                            </tbody>\n                                                        </table>\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class="right-column">\n                                            <div class="card">\n                                                <div class="card-header">Data</div>\n                                                <div class="card-body">\n                                                    <div id="data-hdu-file" class="file-data-container">\n<table id="table-data" class="table table-striped">    <thead>       <tr>       </tr>    </thead>    <tbody class="table-group-divider">    </tbody></table>                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- button class="btn btn-success" id="save-file-settings">Save changes</button --\x3e\n                                    <button class="btn btn-primary" id="add-to-plot">Add to plot</button>\n                                    <button class="btn btn-danger" id="remove-from-plot">Remove from plot</button>\n                                </div>\n                            </div>\n                        </div>'}setupComponent(){this.setHDUSelect(),this.setupActionButtons();let e=document.getElementById(this.select_hdu_id).value;this.setTables(e),this.setupInnerElementListeners()}setHDUSelect(){let e=document.getElementById(this.select_hdu_id);e.innerHTML="";let t=y.getFITSReaderWrapper();t.setFile(this.file.file);let s=t.getHDUs(),i=[];s.forEach((e=>{let t=document.createElement("option");t.value=e.index,t.text=e.name+" "+e.extname,i.push(t)})),i.forEach((t=>{e.add(t)}))}setupInnerElementListeners(){this.setHDUSelectListener()}setupActionButtons(){let e=document.getElementById(this.add_to_plot_btn_id),t=document.getElementById(this.remove_from_plot_btn_id);this.is_current?(e.style.display="none",t.style.display="initial"):(e.style.display="initial",t.style.display="none"),e.addEventListener("click",(e=>{o.addToCurrentFiles(this.file),this.is_current=!0,(new r).dispatchToSubscribers(),this.resetContainerForCurrentFile()})),t.addEventListener("click",(e=>{o.removeFromCurrentFiles(this.file.id),this.is_current=!1,(new r).dispatchToSubscribers(),this.resetContainerForCurrentFile()}))}setTables(e){this.resetTables();let t=document.getElementById(this.table_header_id),s=document.getElementById(this.table_data_id),i=y.getFITSReaderWrapper();i.setFile(this.file.file);let a=i.getHeaderCardsValueFromHDU(e),n=t.querySelector("tbody");a.forEach((e=>{let t=n.insertRow(),s=t.insertCell(0),i=t.insertCell(1),a=t.insertCell(2),r=t.insertCell(3);s.textContent=e.index,i.textContent=e.card_name,a.textContent=e.value,r.textContent=e.comment}));try{let t=i.getColumnsNameFromHDU(e),a=i.getColumnsJSONDataFromHDU(e),r=s.tHead.insertRow();n=s.querySelector("tbody"),t.forEach((e=>{let t=document.createElement("th");t.textContent=e,r.appendChild(t)})),a.forEach((e=>{const t=n.insertRow();for(let s in e)Object.hasOwnProperty.call(e,s)&&(t.insertCell().textContent=e[s])}))}catch(e){console.log("DATA PARSING ERROR")}}resetTables(){let e=document.getElementById(this.table_header_id),t=document.getElementById(this.table_data_id),s=e.querySelector("tbody");s.innerHTML="",s=t.querySelector("tbody");let i=t.querySelector("thead");s.innerHTML="",i.innerHTML="<tr></tr>"}setHDUSelectListener(){document.getElementById(this.select_hdu_id).addEventListener("change",(e=>{this.setTables(e.target.value)}))}resetContainerForCurrentFile(){this.setupComponent()}}class C extends HTMLElement{static component_id="file_component";static select_file="select-file";static input_file_url="file-input-url";static input_file_local="file-input-local";static input_file_type="select-file-type";static load_button="load-file";static available_files_list_id="available-files-list";static current_files_list_id="current-files-list";static file_settings_container_id="file-settings-container";static save_button_id="save-file-settings";static add_button_id="add-to-plot";static remove_button_id="remove-from-plot";container_id;container;fits_reader_wrapper=null;constructor(e){super(),this.container_id=e,this._setContainer(),this.handleFITSLoadedEvent=this.handleFITSLoadedEvent.bind(this),this.handleSelectChangeEvent=this.handleSelectChangeEvent.bind(this),this.handleLoadFileEvent=this.handleLoadFileEvent.bind(this),this.handleFileLoadedEvent=this.handleFileLoadedEvent.bind(this),this.handleFileRegistryChangeEvent=this.handleFileRegistryChangeEvent.bind(this),this._setupExternalListeners(),this._setupInnerListeners(),this._setupInnerElementsListeners()}_setupExternalListeners(){this.addEventListener("fits-loaded",this.handleFITSLoadedEvent),this.addEventListener("file-loaded",this.handleFileLoadedEvent),this.addEventListener("file-registry-change",this.handleFileRegistryChangeEvent)}_setupInnerListeners(){this.addEventListener("select-change",this.handleSelectChangeEvent),this.addEventListener("load-file",this.handleLoadFileEvent)}_setupInnerElementsListeners(){this._setLoadLocalFileButtonListener(),this._setFilesListsListeners()}_setLoadLocalFileButtonListener(){let e=document.getElementById(C.input_file_local),t=document.getElementById(C.input_file_type).value;e.addEventListener("change",(function(e){let s=e.target.files[0];"fits"===t?s.arrayBuffer().then((e=>{y.getFITSReaderWrapper().initializeFromBuffer(e,s.name)})).catch((e=>{console.error("Error reading file as ArrayBuffer:",e)})):"csv"===t&&((new FileReader).onload=function(e){e.target.result})}))}_setFilesListsListeners(){let e=document.getElementById(C.available_files_list_id),t=document.getElementById(C.current_files_list_id),s=e.querySelectorAll("button"),i=t.querySelectorAll("button"),a=Array.from(s).concat(Array.from(i));a.forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");let t=e.getAttribute("aria-current");if(t&&"true"===t)e.removeAttribute("aria-current"),this.clearFileSettingsPanel();else{e.setAttribute("aria-current","true");let t=o.getFileById(e.getAttribute("data-id"));this.setFileSettingsPanel(t)}Array.from(a).filter((t=>t!==e)).forEach((e=>{e.classList.remove("active"),e.removeAttribute("aria-current")}))}))}))}_setFileSettingsButtonsListeners(){let e=document.getElementById(C.save_button_id),t=document.getElementById(C.add_button_id);e.addEventListener("click",(e=>{})),t.addEventListener("click",(e=>{let t=e.target.getAttribute("data-id"),s=o.getFileById(t);o.addToCurrentFiles(s),this.updateCurrentFilesList(),this.updateAvailableFilesList(),(new r).dispatchToSubscribers()}))}handleFITSLoadedEvent(e){this.fits_reader_wrapper=e.detail.fits_reader_wrapper;let t=this.fits_reader_wrapper.getFilePath();this._addFileToSelect(t)}handleFileLoadedEvent(e){o.addToAvailableFiles(e.detail),this.updateAvailableFilesList(),this._setFilesListsListeners()}handleFileRegistryChangeEvent(e){this.updateAvailableFilesList(),this.updateCurrentFilesList(),this._setFilesListsListeners()}handleLoadFileEvent(e){}updateFilesLists(){this.updateAvailableFilesList(),this.updateCurrentFilesList()}updateAvailableFilesList(){let e=document.getElementById(C.available_files_list_id);e.innerHTML="",this._createFileSelection("available").forEach((t=>{e.appendChild(t)}))}updateCurrentFilesList(){let e=document.getElementById(C.current_files_list_id);e.innerHTML="",this._createFileSelection("current").forEach((t=>{e.appendChild(t)}))}clearFileSettingsPanel(){document.getElementById(C.file_settings_container_id).innerHTML=""}setFileSettingsPanel(e){if(this.clearFileSettingsPanel(),"fits"===e.type){let t=o.isFileCurrent(e.id),s=new L(e,t);document.getElementById(C.file_settings_container_id).appendChild(s),s.setupComponent()}}_addFileToSelect(e){let t=this._createSelectOption(e);document.getElementById(C.select_file).add(t)}_createFileSelection(e="available"){let t;t="available"===e?o.getAvailableFilesList():o.getCurrentFilesList();let s,i=[];return t.forEach((e=>{let t=e.id+"."+e.file_name;s=document.createElement("button"),s.setAttribute("type","button"),s.setAttribute("class","available-file-selection list-group-item list-group-item-action"),s.setAttribute("data-id",e.id),s.textContent=t,i.push(s)})),i}_createSelectOption(e){let t=document.createElement("option");return t.value=e,t.text=e,t}handleSelectChangeEvent(e){e.stopPropagation()}_setContainer(){this.container=document.getElementById(this.container_id)}resetContainer(){this.container.innerHTML=""}}class w{static default_settings={library:"",data_type:"",axis:{},scales:{},error_bars:{}};settings={};settings_library=null;settings_data_type=null;settings_hdus=null;settings_axis=null;settings_scales=null;settings_error_bars=null;constructor(e=null){this.settings=e?JSON.parse(JSON.stringify(e)):JSON.parse(JSON.stringify(w.default_settings))}setLibrarySettings(e){this.settings_library=e}getLibrarySettings(){return this.settings_library?this.settings_library:null}setDataTypeSettings(e){this.settings_data_type=e}getDataTypeSettings(){return this.settings_data_type?this.settings_data_type:null}getLightCurveSettings(){}getSpectrumSettings(){}setHDUsSettings(e){this.settings_hdus=e}getHDUsSettings(){return null!==this.settings_hdus?this.settings_hdus:null}setAxisSettings(e){this.settings_axis=e}getAxisSettings(){return this.settings_axis?this.settings_axis:null}setScalesSettings(e){this.settings_scales=e}getScalesSettings(){return this.settings_scales?this.settings_scales:null}setErrorBarsSettings(e){this.settings_error_bars=e}getErrorBarsSettings(){return this.settings_error_bars?this.settings_error_bars:null}setRangesSettings(e){this.settings_ranges=e}getRangesSettings(){return this.settings_ranges}getAdditionalDatasetsSettings(){}reset(){this.settings_library=null,this.settings_data_type=null,this.settings_hdus=null,this.settings_axis=null,this.settings_scales=null,this.settings_error_bars=null}}class D{constructor(){}getVisualizationSettingsObject(){return new w}getSettingsConfigurationObject(){return new b}static getSettingsContainer(){return new D}}class T extends Error{constructor(e){super(e),this.name="NoEventToDispatch"}}class B{static defaultOptions={bubbles:!0,composed:!1,cancelable:!0};static name="settings-changed";event=null;constructor(e,t={},s={}){this.detail={...t,settings_object:e},this.options={...B.defaultOptions,...s},this.event=new CustomEvent(B.name,{detail:this.detail,...this.options})}dispatch(){if(null===this.event)throw new T("No event to dispatch");document.dispatchEvent(this.event)}}class I{static defaultOptions={bubbles:!0,composed:!1,cancelable:!0};static name="visualization-generation";event=null;constructor(e,t={},s={}){this.detail={...t,settings_object:e},this.options={...I.defaultOptions,...s},this.event=new CustomEvent(I.name,{detail:this.detail,...this.options})}dispatch(){if(null===this.event)throw new T("No event to dispatch");document.dispatchEvent(this.event)}}class A extends HTMLElement{container_id;container;static component_id="settings_component";static container_id="settings-component";static select_library_id="select-library";static select_data_type_id="select-data-type";static light_curve_settings_id="light-curve-settings";static spectrum_settings_id="spectrum-settings";static select_hdus_id="select-hdus";static calculation_radio_class="calculation-radio";static select_axis_x_id="select-axis-x";static select_axis_y_id="select-axis-y";static select_error_bar_x_id="select-axis-x-error-bar";static select_error_bar_y_id="select-axis-y-error-bar";static supported_data_types=["generic","light-curve","spectrum"];fits_reader_wrapper=null;settings_object=null;constructor(){super(),this.container_id=A.container_id,this._setContainer(),this.settings_object=D.getSettingsContainer().getVisualizationSettingsObject(),this.handleFITSLoadedEvent=this.handleFITSLoadedEvent.bind(this),this.handleConfigurationEvent=this.handleConfigurationEvent.bind(this),this.handleLibraryChangeEvent=this.handleLibraryChangeEvent.bind(this),this.handleDataTypeChangeEvent=this.handleDataTypeChangeEvent.bind(this),this.handleHDUsChangeEvent=this.handleHDUsChangeEvent.bind(this),this.handleGenerateEvent=this.handleGenerateEvent.bind(this),this.handleFileChangeEvent=this.handleFileChangeEvent.bind(this),this._setupExternalListeners(),this._setupInnerListeners(),this._setupInnerElementsListeners()}_setupExternalListeners(){this.addEventListener("fits-loaded",this.handleFITSLoadedEvent),this.addEventListener("configuration",this.handleConfigurationEvent),this.addEventListener("file-registry-change",this.handleFileChangeEvent)}_setupInnerListeners(){this.addEventListener("select-library-change",this.handleLibraryChangeEvent),this.addEventListener("select-data-type-change",this.handleDataTypeChangeEvent),this.addEventListener("select-hdus-change",this.handleHDUsChangeEvent),this.addEventListener("button-generate-click",this.handleGenerateEvent)}_setupInnerElementsListeners(){this._setSelectLibraryListener(),this._setSelectDataTypeListener(),this._setSelectHDUsListener(),this._setGenerateButtonListener(),this._setCalculationRadioListeners()}handleFITSLoadedEvent(e){this.fits_reader_wrapper=e.detail.fits_reader_wrapper;let t=this.fits_reader_wrapper.getHDUs();if(this._setSelectHDUs(t),this.fits_reader_wrapper.isHDUTabular(t[0].index)){let e=this.fits_reader_wrapper.getColumnsNameFromHDU(t[0].index);this._setSelectAxis(e),this._setSelectErrorBars(e)}else this._resetSelectAxis(),this._resetSelectErrorBars()}handleConfigurationEvent(e){let t=e.detail.configuration_object;this.updateSettings(t)}handleLibraryChangeEvent(e){e.stopPropagation(),this.updateSettingsObject(),new B(this.settings_object).dispatch()}handleDataTypeChangeEvent(e){e.stopPropagation();let t=e.detail.data_type;if(A.supported_data_types.includes(t))switch(this.updateSettingsObject(),t){case"light-curve":document.getElementById(A.light_curve_settings_id).style.display="block",document.getElementById(A.spectrum_settings_id).style.display="none";break;case"spectrum":document.getElementById(A.spectrum_settings_id).style.display="block",document.getElementById(A.light_curve_settings_id).style.display="none";break;default:document.getElementById(A.spectrum_settings_id).style.display="none",document.getElementById(A.light_curve_settings_id).style.display="none"}}handleHDUsChangeEvent(e){e.stopPropagation();let t=e.detail.hdu_index;if(this.fits_reader_wrapper.isHDUTabular(t)){let e=this.fits_reader_wrapper.getColumnsNameFromHDU(t);this._setSelectAxis(e),this._setSelectErrorBars(e)}else this._resetSelectAxis(),this._resetSelectErrorBars()}handleGenerateEvent(e){e.stopPropagation(),this.settings_object.reset(),this.updateSettingsObject(),new I(this.settings_object).dispatch()}handleFileChangeEvent(e){let t=o.getCurrentFilesList(),s=[];t.forEach((e=>{if("fits"===e.type){let t=y.getFITSReaderWrapper();t.setFile(e.file),t.getAllColumns().forEach((t=>{let i={...t,file_id:e.id};s.push(i)}))}else e.type}));let i=s.reduce(((e,t)=>(e[t.file_id]||(e[t.file_id]=[]),e[t.file_id].push(t),e)),{}),a=[];for(let e in i)if(i.hasOwnProperty(e)){let t=o.getFileById(e),s=t.file_name,n=y.getFITSReaderWrapper();n.setFile(t.file),a.push(this._createFileColumnsOptionsGroup(i[e],s,"opt-group",n))}this._setSelectGroupAxis(a),this._setSelectGroupErrorBars(a)}_setContainer(){this.container=document.getElementById(this.container_id)}_resetContainer(){this.container.innerHTML=""}_setSelectHDUs(e){this._resetSelectHDUs();let t=document.getElementById(A.select_hdus_id);this._createHDUsOptions(e).forEach((function(e){t.add(e)}))}_resetSelectHDUs(){document.getElementById(A.select_hdus_id).innerHTML=""}_createHDUsOptions(e){let t,s=[];return e.forEach((function(e,i){t=document.createElement("option"),0===i&&t.setAttribute("selected","true"),t.value=e.index,t.text=e.name,s.push(t)})),s}_createFileColumnsOptionsGroup(e,t,s,i){let a=document.createElement("optgroup");return a.label=t,a.className+=s,e.forEach((e=>{let t=document.createElement("option"),s=i.getHeaderCardValueByNameFromHDU(e.hdu_index,"XTENSION")+"-"+i.getHeaderCardValueByNameFromHDU(e.hdu_index,"EXTNAME")+" "+e.name;e.is_from_header&&(s+="(HEADER)"),e.is_processed?(t.text=s,t.value=`${e.from_file}.${e.hdu_index}$${e.name}`):(t.text=s,t.value=`${e.file_id}.${e.hdu_index}$${e.name}`),a.appendChild(t)})),a}_setSelectAxis(e){this._resetSelectAxis();let t=[document.getElementById(A.select_axis_x_id),document.getElementById(A.select_axis_y_id)];this._createColumnsOptions(e).forEach((function(e){t.forEach((function(t){let s=e.cloneNode(!0);t.add(s)}))}))}_setSelectGroupAxis(e){this._resetSelectAxis();let t=[document.getElementById(A.select_axis_x_id),document.getElementById(A.select_axis_y_id)];e.forEach((e=>{t.forEach((t=>{let s=e.cloneNode(!0);t.add(s)}))}))}_resetSelectAxis(){let e=document.getElementById(A.select_axis_x_id),t=document.getElementById(A.select_axis_y_id);e.innerHTML="",t.innerHTML=""}_setSelectErrorBars(e){this._resetSelectErrorBars();let t=[document.getElementById(A.select_error_bar_x_id),document.getElementById(A.select_error_bar_y_id)];this._createColumnsOptions(e).forEach((function(e){t.forEach((function(t){let s=e.cloneNode(!0);t.add(s)}))}))}_setSelectGroupErrorBars(e){this._resetSelectErrorBars();let t=[document.getElementById(A.select_error_bar_x_id),document.getElementById(A.select_error_bar_y_id)];e.forEach((e=>{t.forEach((t=>{let s=e.cloneNode(!0);t.add(s)}))}))}_resetSelectErrorBars(){let e=document.getElementById(A.select_error_bar_x_id),t=document.getElementById(A.select_error_bar_y_id);e.innerHTML="",t.innerHTML=""}_createColumnsOptions(e){let t,s=[];return e.forEach((function(e){t=document.createElement("option"),t.value=e,t.text=e,s.push(t)})),s}_setSelectLibraryListener(){let e=document.getElementById(A.select_library_id);e.addEventListener("change",(t=>{t.preventDefault();const s=new CustomEvent("select-library-change",{bubbles:!1,compose:!1,cancelable:!0,detail:{library:e.value}});this.dispatchEvent(s)}))}_setSelectDataTypeListener(){let e=document.getElementById(A.select_data_type_id);e.addEventListener("change",(t=>{t.preventDefault();const s=new CustomEvent("select-data-type-change",{bubbles:!1,compose:!1,cancelable:!0,detail:{data_type:e.value}});this.dispatchEvent(s)}))}_setSelectHDUsListener(){let e=document.getElementById(A.select_hdus_id);e.addEventListener("change",(t=>{t.preventDefault();const s=new CustomEvent("select-hdus-change",{bubbles:!1,compose:!1,cancelable:!0,detail:{hdu_index:e.value}});this.dispatchEvent(s)}))}_setCalculationRadioListeners(){document.querySelectorAll("."+A.calculation_radio_class).forEach((e=>{e.addEventListener("change",(e=>{}))}))}_setGenerateButtonListener(){document.getElementById("button-generate").addEventListener("click",(e=>{e.preventDefault();const t=new CustomEvent("button-generate-click",{bubbles:!1,compose:!1,cancelable:!0,detail:{}});this.dispatchEvent(t)}))}updateSettings(e){for(let[t,s]of Object.entries(e)){let e=document.getElementById(t);e&&(!0===s.display?e.style.display="block":e.style.display="none")}}updateSettingsObject(){let e=this._extractFormValues(),t={};t.library=e["select-library"].value,this.settings_object.setLibrarySettings(t);let s={};s.hdu_index=e["select-hdus"].value,this.settings_object.setHDUsSettings(s);let i={};if(i.type=e["select-data-type"].value,this.settings_object.setDataTypeSettings(i),e["select-axis-x"]&&e["select-axis-y"]){let t={},s={};t.x=e["select-axis-x"].value,t.y=e["select-axis-y"].value,s.x=e["select-axis-x-scale"].value,s.y=e["select-axis-y-scale"].value,this.settings_object.setAxisSettings(t),this.settings_object.setScalesSettings(s)}if(e["has-error-bars-checkbox"]&&!0===e["has-error-bars-checkbox"].checked){let t={};t.x=e["select-axis-x-error-bar"].value,t.y=e["select-axis-y-error-bar"].value,this.settings_object.setErrorBarsSettings(t)}if(!0===e["has-x-range-checkbox"].checked||!0===e["has-y-range-checkbox"].checked){let t={x:{},y:{}};!0===e["has-x-range-checkbox"].checked?(t.x.lower_bound=e["x-lower-bound"].value,t.x.upper_bound=e["x-higher-bound"].value):t.x=null,!0===e["has-y-range-checkbox"].checked?(t.y.lower_bound=e["y-lower-bound"].value,t.y.upper_bound=e["y-higher-bound"].value):t.y=null,this.settings_object.setRangesSettings(t)}else this.settings_object.setRangesSettings(null)}_extractFormValues(){let e={};return this.container.querySelectorAll(".form-select").forEach((t=>{let s=t.id,i=t.className.split(" "),a=t.value;"none"!==window.getComputedStyle(t,null).getPropertyValue("display")&&"none"!==a&&(e[s]={classes:i,value:a})})),this.container.querySelectorAll(".form-checkbox").forEach((t=>{let s=t.id,i=t.className.split(" "),a=t.checked;e[s]={classes:i,checked:a}})),this.container.querySelectorAll(".form-input").forEach((t=>{let s=t.id,i=t.className.split(" "),a=t.value;e[s]={classes:i,value:a}})),e}}class H extends HTMLElement{container_id;container;constructor(e){super(),this.container_id=e,this._setContainer()}_setContainer(){this.container=document.getElementById(this.container_id)}resetContainer(){this.container.innerHTML=""}}class N extends HTMLElement{constructor(e){super()}}let k=file_url,O=new c(k),U=new F,j=new f;return y.setFITSReaderWrapper(O),y.setBokehWrapper(U),y.setD3Wrapper(j),g.setBokehVisualization(new u),g.setD3Visualization(new _),customElements.define("file-component",C),customElements.define("settings-component",A),customElements.define("visualization-component",H),customElements.define("fits-component",L),customElements.define("csv-component",N),e})()));